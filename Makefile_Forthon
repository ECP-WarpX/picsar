SRCDIR= src
BINDIR = python_bin
APPNAME=picsar
PYTHON_NAME=picsarpy
UTIL=utils
FC=Forthon
FCARGS=-v --no2underscores  --nowritemodules
FCOMP=gfortran
FCOMPEXEC=mpif90
FARGS="-O3 -fopenmp  -ffree-line-length-none -ftree-vectorize -ftree-vectorizer-verbose=0"
LIBDIR=-L/usr/local/Cellar/open-mpi/1.10.1_1/lib/
LIBS=-lmpi -lmpi_usempif08 -lmpi_mpifh -lgomp
TESTDIR=example_scripts_python



all: clean parse build 


build: $(SRCDIR)/$(APPNAME).F90 $(SRCDIR)/$(APPNAME).v
	cd $(SRCDIR) &&\
	$(FC) $(VERBOSE) $(FCARGS) --fcomp=$(FCOMP) --fcompexec=$(FCOMPEXEC) --fargs=$(FARGS) $(LIBDIR) $(LIBS)  $(APPNAME)
	mkdir -p $(BINDIR)
	cp $(SRCDIR)/build/*/*/$(PYTHON_NAME).so $(BINDIR)

parse:
	python $(UTIL)/forthon_parser.py

clean:
	rm -rf $(SRCDIR)/build
	rm -rf $(BINDIR)

test:
	mpirun -np 1 python $(TESTDIR)/test.py
