SRCDIR= src
BINDIR = python_bin
APPNAME=picsar
PYTHON_NAME=picsarpy
UTIL=utils
FC=Forthon
FCARGS=-v --no2underscores  --nowritemodules
FCOMP=gfortran
FCOMPEXEC=mpif90
FARGS="-O3 -fopenmp -ffree-line-length-none -ftree-vectorize -ftree-vectorizer-verbose=0"

LIBDIR=
LIBS=

TESTDIR=example_scripts_python

all: clean parse build
test: test1 test2


build: $(SRCDIR)/$(APPNAME).F90 $(SRCDIR)/$(APPNAME).v
	cd $(SRCDIR) &&\
	$(FC) $(VERBOSE) $(FCARGS) --fcomp=$(FCOMP) --fcompexec=$(FCOMPEXEC) --fargs=$(FARGS) $(LIBDIR) $(LIBS)  $(APPNAME)
	mkdir -p $(BINDIR)
	cp $(SRCDIR)/build/*/*/$(PYTHON_NAME).so $(BINDIR)

parse:
	python $(UTIL)/forthon_parser.py

clean:
	rm -rf $(SRCDIR)/build
	rm -rf $(BINDIR)

test1:
	cp -p example_scripts_python/test.py Acceptance_testing/Python_tests/test
	export OMP_NUM_THREADS=1
	cd Acceptance_testing/Python_tests/test && \
	mpirun -np 1 python test.py
	
test2:
	cp -p example_scripts_python/test_Langmuir_wave_3d.py Acceptance_testing/Python_tests/test_Langmuir_wave/
	export OMP_NUM_THREADS=2
	cd Acceptance_testing/Python_tests/test_Langmuir_wave && \
	mpirun -np 4 python test_Langmuir_wave_3d.py
