# Makefile for profiling:
# - SDE
# - Vtune
# - Allinea Map
#
# PROFILING:
# - 0: No profiling
# - 1: Analysis of the kernel without the initialization
# - 2: Analysis of the current deposition
# - 3: Analysis of the field gathering
# ______________________________________________________________________________

# Preparation
# Following parameters can be tuned for your system

# C compiler
CC=icc

# Fortran compiler
FC=mpiifort

# Fortran arguments
FARGS= -D DFP=1 -D SDE=1 -D VTUNE=1 -O3 -align array64byte -g -Bdynamic -qopenmp -xMIC-AVX512 -debug inline-debug-info
#-opt-streaming-stores always -DSTREAM_ARRAY_SIZE=64000000 -align array64byte -xMIC-AVX512 

# C arguments
CARGS= -D DFP=1 -D SDE=1 -D VTUNE=1 -O3 -g -Bdynamic -qopenmp -xMIC-AVX512 -I $(VTUNE_AMPLIFIER_XE_2016_DIR)/include -debug inline-debug-info

# Path to Vtune for Vtune start and stop functions
LDFLAGS=$(VTUNE_AMPLIFIER_XE_2016_DIR)/lib64/libittnotify.a

# Source directory
SRCDIR= src

# Binary directory
BINDIR=fortran_bin

# Application name
APPNAME=picsar_knl_ai

# ______________________________________________________________________________
# Compilation

$(SRCDIR)/%.o:$(SRCDIR)/%.c
	$(CC) $(CARGS) -c -o $@ $<

$(SRCDIR)/%.o:$(SRCDIR)/%.F90
	$(FC) $(FARGS) -c -o $@ $<

all: clean build
test: test1 test2 test3

build:$(SRCDIR)/modules.o \
	$(SRCDIR)/api_fortran_itt.o \
	$(SRCDIR)/api_fortran_sde.o \
	$(SRCDIR)/itt_fortran.o \
	$(SRCDIR)/sde_fortran.o \
	$(SRCDIR)/maxwell.o \
	$(SRCDIR)/tiling.o \
	$(SRCDIR)/sorting.o \
	$(SRCDIR)/particles_push_2d.o \
	$(SRCDIR)/particles_push.o \
	$(SRCDIR)/current_deposition_2d.o \
	$(SRCDIR)/current_deposition.o \
	$(SRCDIR)/field_gathering_2d.o \
	$(SRCDIR)/field_gathering_3d_o1.o \
	$(SRCDIR)/field_gathering_3d_o2.o \
	$(SRCDIR)/field_gathering_3d_o3.o \
	$(SRCDIR)/field_gathering.o \
	$(SRCDIR)/mpi_derived_types.o \
	$(SRCDIR)/boundary.o \
	$(SRCDIR)/charge_deposition.o \
	$(SRCDIR)/diags.o \
	$(SRCDIR)/simple_io.o \
	$(SRCDIR)/mpi_routines.o \
	$(SRCDIR)/submain.o \
	$(SRCDIR)/control_file.o \
	$(SRCDIR)/main.o
	$(FC) $(FARGS) -o $(APPNAME) $(SRCDIR)/*.o $(LDFLAGS)
	mkdir -p $(BINDIR)
	mv $(APPNAME) $(BINDIR)
	
clean:
	rm -rf $(SRCDIR)/*.o *.mod $(BINDIR)/$(APPNAME) RESULTS

test1:
	cd Acceptance_testing/Fortran_tests/test_plasma_drift && \
	py.test -s --ttest=1 --trun=1
test2:
	cd Acceptance_testing/Fortran_tests/test_homogeneous_plasma && \
	py.test -s --ttest=1 --trun=1	
test3:
	cd Acceptance_testing/Fortran_tests/test_Langmuir_wave && \
	py.test -s --ttest=1 --trun=1

